<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        const pcConfig = {
            'iceServers': [{ url: 'stun:stun01.sipphone.com' },
            { url: 'stun:stun.ekiga.net' },
            { url: 'stun:stun.fwdnet.net' },
            { url: 'stun:stun.ideasip.com' },
            { url: 'stun:stun.iptel.org' },
            { url: 'stun:stun.rixtelecom.se' },
            { url: 'stun:stun.schlund.de' },
            { url: 'stun:stun.l.google.com:19302' },
            { url: 'stun:stun1.l.google.com:19302' },
            { url: 'stun:stun2.l.google.com:19302' },
            { url: 'stun:stun3.l.google.com:19302' },
            { url: 'stun:stun4.l.google.com:19302' },
            { url: 'stun:stunserver.org' },
            { url: 'stun:stun.softjoys.com' },
            { url: 'stun:stun.voiparound.com' },
            { url: 'stun:stun.voipbuster.com' },
            { url: 'stun:stun.voipstunt.com' },
            { url: 'stun:stun.voxgratia.org' },
            { url: 'stun:stun.xten.com' },
            {
                url: 'turn:numb.viagenie.ca',
                credential: 'muazkh',
                username: 'webrtc@live.com'
            },
            {
                url: 'turn:192.158.29.39:3478?transport=udp',
                credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                username: '28224511:1379330808'
            },
            {
                url: 'turn:192.158.29.39:3478?transport=tcp',
                credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                username: '28224511:1379330808'
            }]
        }

        const socket = new WebSocket('wss://just-chat.kro.kr:55316')

        function send_msg(msg) {
            console.log("send", msg)
            socket.send(JSON.stringify(msg))
        }

        pc = new RTCPeerConnection(pcConfig)
        pc.onicecandidate = function (event) {
            if (event.candidate) {
                send_msg({
                    type: "icecandidate",
                    candidate: event.candidate.candidate,
                    sdpMid: event.candidate.sdpMid,
                    sdpMLineIndex: event.candidate.sdpMLineIndex
                })
            } else {
                console.log('---end---')
                socket.close()
            }
        }

        socket.onmessage = function (event) {
            console.log(event)
            data = JSON.parse(event.data)
            if (data.type == "start") {
                console.log("start")
                pc.createOffer().then(
                    function (offer) {
                        pc.setLocalDescription(offer)
                        send_msg(offer)
                    }
                )
            } else if (data.type == "offer") {
                console.log("offer")
                pc.setRemoteDescription(new RTCSessionDescription(data))
                pc.createAnswer().then(
                    function (answer) {
                        pc.setLocalDescription(answer)
                        send_msg(answer)
                    }
                )
            } else if (data.type == "answer") {
                console.log("answer")
                pc.setRemoteDescription(new RTCSessionDescription(data))
            } else if (data.type == "icecandidate") {
                console.log("icecandidate")
                const icecandidate = new RTCIceCandidate({
                    candidate: data.candidate,
                    sdpMid: data.sdpMid,
                    sdpMLineIndex: data.sdpMLineIndex
                })
                pc.addIceCandidate(icecandidate)
            }
        }

        sendChannel = pc.createDataChannel("DataChannel", null)
        pc.ondatachannel = function (event) {
            receiveChannel = event.channel
            receiveChannel.onmessage = function (event) {
                console.log(event)
                alert(event.data)
            }
        }

    </script>
</body>

</html>
